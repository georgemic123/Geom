<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#08101a" />
  <title>BetAnalytics Pro â€” Proportional</title>

  <style>

*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%}
body{
  font-family:"Segoe UI",Roboto,"Helvetica Neue",sans-serif;
  background:linear-gradient(135deg,#0f1419 0%,#1a1f3a 100%);
  padding:15px 10px;
  color:#e0e0e0;
  overflow-x:hidden;
  min-height:100vh;
  -webkit-text-size-adjust:100%;
}
:root{
  --cyan:#00d4ff;
  --cyan2:#0099cc;
  --green:#00ff88;
  --red:#ff3366;
  --amber:#ffc107;
  --muted:#7a8fa6;
  --panel:rgba(26,31,58,.95);
  --panelBorder:rgba(0,212,255,.15);
}

.wrap{
  max-width:1200px;
  width:100%;
  margin:0 auto;
  background:var(--panel);
  border-radius:16px;
  padding:28px 20px;
  box-shadow:0 20px 60px rgba(0,0,0,.5);
  border:1px solid rgba(0,212,255,.1);
}
.title{
  text-align:center;
  margin-bottom:10px;
  font-size:28px;
  color:var(--cyan);
  font-weight:300;
  letter-spacing:2px;
}
.subtitle{
  text-align:center;
  color:var(--muted);
  font-size:11px;
  margin-bottom:28px;
  text-transform:uppercase;
  letter-spacing:1px;
}

/* tabs */
.tabs{
  display:flex;
  gap:10px;
  margin-bottom:28px;
  border-bottom:2px solid rgba(0,212,255,.2);
  padding-bottom:12px;
  flex-wrap:wrap;
}
.tab{
  padding:12px 20px;
  background:rgba(0,212,255,.10);
  border:1px solid rgba(0,212,255,.20);
  border-radius:8px 8px 0 0;
  color:var(--muted);
  font-size:13px;
  font-weight:700;
  cursor:pointer;
  transition:.25s;
  text-transform:uppercase;
  letter-spacing:1px;
  flex:1 1 0;
  min-width:150px;
  text-align:center;
  user-select:none;
}
.tab.active{
  background:linear-gradient(135deg, rgba(0,212,255,.20), rgba(0,212,255,.10));
  border-color:var(--cyan);
  color:var(--cyan);
}
.tab:hover{background:rgba(0,212,255,.15)}

/* sections / panels */
.panel{
  background:linear-gradient(135deg, rgba(0,212,255,.05), rgba(0,212,255,.02));
  border:1px solid var(--panelBorder);
  border-radius:12px;
  padding:22px 20px;
  margin-bottom:28px;
}
.sectionTitle{
  margin:14px 0 10px;
  font-size:11px;
  font-weight:700;
  color:var(--muted);
  text-transform:uppercase;
  letter-spacing:.7px;
}
.field{display:flex;flex-direction:column;margin-bottom:16px}
label{
  font-size:10px;
  font-weight:700;
  color:var(--muted);
  margin-bottom:7px;
  text-transform:uppercase;
  letter-spacing:.5px;
}
input,select{
  padding:12px;
  border:1px solid rgba(0,212,255,.2);
  border-radius:8px;
  font-size:16px; /* prevent iOS zoom */
  font-family:inherit;
  background:rgba(255,255,255,.05);
  color:#e0e0e0;
  width:100%;
}
input:focus,select:focus{
  outline:none;
  border-color:var(--cyan);
  background:rgba(0,212,255,.08);
  box-shadow:0 0 10px rgba(0,212,255,.15);
}
select{appearance:none;-webkit-appearance:none}

/* buttons */
.btn, button{
  padding:13px 24px;
  background:linear-gradient(135deg,var(--cyan),var(--cyan2));
  color:#0f1419;
  border:none;
  border-radius:8px;
  font-size:13px;
  font-weight:800;
  cursor:pointer;
  text-transform:uppercase;
  letter-spacing:1px;
  margin-top:12px;
  width:100%;
  transition:.2s;
}
.btn:hover, button:hover{
  transform:translateY(-2px);
  box-shadow:0 8px 20px rgba(0,212,255,.30);
}
.btn:active, button:active{transform:scale(.98)}
.btn.ghost{background:rgba(0,212,255,.10);color:#e0e0e0;border:1px solid rgba(0,212,255,.20)}
.btn.good, .good{color:var(--green)}
.btn.bad, .bad{color:var(--red)}
.btn.primary, .primary{}

/* stats cards */
.stats{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:12px;
  margin-bottom:18px;
}
@media(min-width:600px){.stats{grid-template-columns:repeat(3,1fr)}}
@media(min-width:900px){.stats{grid-template-columns:repeat(5,1fr)}}

.card{
  background:linear-gradient(135deg, rgba(0,212,255,.08), rgba(0,212,255,.03));
  border:1px solid rgba(0,212,255,.15);
  border-radius:12px;
  padding:18px 16px;
  text-align:center;
  transition:.3s;
}
.card:hover{
  transform:translateY(-3px);
  border-color:var(--cyan);
  box-shadow:0 8px 20px rgba(0,212,255,.20);
}
.card .k{
  font-size:10px;
  color:var(--muted);
  text-transform:uppercase;
  font-weight:800;
  margin-bottom:9px;
  letter-spacing:1px;
}
.card .v{
  font-size:22px;
  font-weight:800;
  color:var(--cyan);
  font-family:"Courier New", monospace;
}
.card .v.good{color:var(--green)}
.card .v.bad{color:var(--red)}
.card .v.neutral{color:var(--amber)}

.formGrid{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:12px;
}
@media(min-width:700px){.formGrid{grid-template-columns:repeat(4,1fr)}}

.inline-range{display:flex;gap:12px;flex-wrap:wrap}
.inline-range .field{flex:1 1 0;min-width:140px}

/* leagues grid */
.checkGrid{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:15px 18px;
  margin-bottom:16px;
}
@media(min-width:600px){.checkGrid{grid-template-columns:repeat(3,1fr)}}
.checkGrid label{
  margin:0;
  font-size:13px;
  cursor:pointer;
  line-height:1.5;
  font-weight:800;
  color:#fff;
  text-transform:uppercase;
  letter-spacing:.3px;
}
.checkGrid input[type="checkbox"]{
  width:22px;height:22px;
  accent-color:var(--cyan);
  flex-shrink:0;
  cursor:pointer;
}

/* table */
.tableWrap{overflow-x:auto;margin:0 -20px;padding:0 20px}
table{width:100%;border-collapse:collapse;margin-bottom:20px;font-size:12px}
th{
  background:linear-gradient(135deg, rgba(0,212,255,.15), rgba(0,212,255,.08));
  color:var(--cyan);
  padding:13px 9px;
  text-align:left;
  font-size:10px;
  font-weight:800;
  text-transform:uppercase;
  letter-spacing:.5px;
  border-bottom:2px solid rgba(0,212,255,.20);
  white-space:nowrap;
}
td{
  padding:13px 9px;
  border-bottom:1px solid rgba(0,212,255,.10);
  font-family:"Courier New", monospace;
  font-size:11px;
}
tr{transition:.2s}
tr:hover{background:rgba(0,212,255,.05)}
tr.win{background:rgba(0,255,136,.08)}
tr.loss{background:rgba(255,51,102,.08)}
tr.push{background:rgba(122,143,166,.08)}
tr.pending{background:rgba(255,193,7,.08)}

/* pills/badges */
.pill{
  display:inline-block;
  padding:4px 8px;
  border-radius:4px;
  font-size:9px;
  font-weight:800;
  background:rgba(0,212,255,.20);
  color:var(--cyan);
  white-space:nowrap;
}
.pill.good{background:rgba(0,255,136,.18);color:var(--green)}
.pill.bad{background:rgba(255,51,102,.18);color:var(--red)}
.pill.neutral{background:rgba(255,193,7,.18);color:var(--amber)}

/* modal */
.modalBackdrop_unused{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.85);
  z-index:9998;
  backdrop-filter:blur(8px);
}
.modal{
  display:none;
  position:fixed;
  top:50%;left:50%;
  transform:translate(-50%,-50%);
  background:linear-gradient(135deg, rgba(26,31,58,.98), rgba(15,20,25,.98));
  border:2px solid rgba(0,212,255,.30);
  border-radius:16px;
  padding:30px 22px;
  z-index:9999;
  max-width:90%;
  width:450px;
  box-shadow:0 30px 90px rgba(0,212,255,.40);
  max-height:90vh;
  overflow-y:auto;
}

@media(max-width:600px){
  body{padding:10px 6px}
  .wrap{padding:22px 16px;border-radius:12px}
  .title{font-size:24px}
  .subtitle{font-size:10px;margin-bottom:22px}
  .tabs{gap:8px}
  .tab{padding:10px 14px;font-size:11px;min-width:120px}
  .panel{padding:18px 14px}
  table{font-size:10px}
  th,td{padding:11px 7px}
}


/* ===== Legacy-style inline panels (no popups) ===== */
.inlinePanel{
  margin: 14px 0 28px;
  background: linear-gradient(135deg, rgba(0,212,255,0.05), rgba(0,212,255,0.02));
  border: 1px solid rgba(0,212,255,0.18);
  border-radius: 12px;
  padding: 18px 16px;
}
.inlinePanelHeader{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  margin-bottom:10px;
}
.inlinePanelTitle{
  color: rgb(0,212,255);
  font-weight: 700;
  letter-spacing: 0.5px;
  text-transform: uppercase;
  font-size: 12px;
}
.smallBtn{
  padding: 8px 10px;
  font-size: 11px;
  width: auto;
  margin-top: 0;
  border-radius: 8px;
  background: rgba(122,143,166,0.25);
  color: rgb(224,224,224);
}
.smallBtn:hover{ transform:none; box-shadow:none; background: rgba(122,143,166,0.4); }
.smallHint{
  color: rgb(122,143,166);
  font-size: 11px;
  margin-bottom: 10px;
  line-height: 1.5;
}
.tableWrap{ overflow-x:auto; }
.checkGrid{
  display:grid;
  grid-template-columns: repeat(2, minmax(0,1fr));
  gap: 10px 14px;
}
@media (min-width:600px){ .checkGrid{ grid-template-columns: repeat(3, minmax(0,1fr)); } }
.chk{
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px 10px;
  border-radius: 10px;
  border: 1px solid rgba(0,212,255,0.12);
  background: rgba(0,0,0,0.18);
}
.chk:hover{ border-color: rgba(0,212,255,0.28); background: rgba(0,0,0,0.25); }
.chk input{ width:22px; height:22px; accent-color: rgb(0,212,255); }
.chk span{
  font-size: 12px;
  font-weight: 700;
  color: rgb(255,255,255);
  text-transform: uppercase;
  letter-spacing: 0.3px;
  line-height: 1.35;
}

</style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="title">âš¡ BetAnalytics Pro</div>
        <div class="subtitle">ADVANCED PROPORTIONAL EDGE TRACKING SYSTEM</div>
      </div>
    </header>

    <div class="tabs">
      <div class="tab active" id="tabTracker">ðŸ§¾ Proportional Bets</div>
      <div class="tab" id="tabCalc">ðŸ§® Calculator</div>
      <div style="flex:1"></div>
      <button class="btn ghost" id="btnExport" type="button">â¬‡ Export CSV</button>
      <button class="btn ghost" id="btnImport" type="button">â¬† Import CSV</button>
      <input type="file" id="fileImport" accept=".csv,text/csv" style="display:none" />
    </div>

    <!-- TRACKER -->
    <section id="screenTracker" class="panel" style="margin-top:12px;">
      <div class="row tight" style="align-items:center;">
        <div class="field" style="flex:2">
          <label>Bet Type</label>
          <select id="betType">
            <option value="all">All bets</option>
            <option value="live">Live bets only</option>
            <option value="prematch">Pre-match only</option>
          </select>
        </div>
        <div class="field" style="flex:1">
          <label>&nbsp;</label>
          <button class="btn primary" id="btnFilters" type="button">ðŸ§ª Filters</button>
        </div>
        <div class="field" style="flex:1">
          <label>&nbsp;</label>
          <button class="btn" id="btnOddsStats" type="button">ðŸ“Š Odds Buckets</button>
        </div>
        <div class="field" style="flex:1">
          <label>&nbsp;</label>
          <button class="btn bad" id="btnDangerZone" type="button">ðŸ§¹ Reset</button>
        </div>
      </div>

      <div class="stats" id="statsGrid"></div>

      <div class="sectionTitle">Add Proportional Bet</div>
      <div class="formGrid">
        <div class="field" style="grid-column: span 2;">
          <label>Date</label>
          <input id="inDate" type="date" />
        </div>

        <div class="field" style="grid-column: span 2;">
          <label>League</label>
          <input id="inLeague" list="leagueList" placeholder="Select or type custom..." autocomplete="off" />
          <datalist id="leagueList"></datalist>
        </div>

        <div class="field">
          <label>Odds</label>
          <input id="inOdds" inputmode="decimal" enterkeyhint="next" placeholder="1.56" />
        </div>

        <div class="field">
          <label>Units</label>
          <input id="inUnits" inputmode="decimal" enterkeyhint="next" placeholder="10" />
        </div>

        <div class="field">
          <label>Edge %</label>
          <input id="inEdge" inputmode="decimal" enterkeyhint="next" placeholder="4.80" />
        </div>

        <div class="field">
          <label>Result</label>
          <select id="inResult">
            <option value="PENDING">Pending</option>
            <option value="WIN">Win</option>
            <option value="LOSS">Loss</option>
          </select>
        </div>

        <div class="field" style="grid-column: span 2;">
          <label>Live bet</label>
          <select id="inLive">
            <option value="0">No</option>
            <option value="1">Yes</option>
          </select>
        </div>

        <div class="field" style="grid-column: span 2;">
          <label>&nbsp;</label>
          <button class="btn good" id="btnAddBet" type="button">âœ… Add Bet</button>
        </div>
      </div>

      <div class="hint">
        Tip: Odds/Units/Edge accept <b>dot</b> or <b>comma</b>. Display stays with dot. New bets appear <b>at the bottom</b> (saved order).
      </div>

      <div class="sectionTitle">Bets</div>
      <div class="tableWrap" style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>League</th>
              <th>Odds</th>
              <th>Units</th>
              <th>Edge %</th>
              <th>P/L</th>
              <th>Result</th>
              <th>Live</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="betsTbody"></tbody>
        </table>
      </div>
    </section>
  <!-- INLINE PANELS (legacy-style) -->
  <section id="filtersPanel" class="inlinePanel" style="display:none;">
    <div class="inlinePanelHeader">
      <div class="inlinePanelTitle">Leagues / Competitions</div>
      <button type="button" class="smallBtn" id="btnHideFiltersPanel">Close</button>
    </div>
    <div class="smallHint">Select the competitions you want included. (This used to be the old table.)</div>
    <div id="leagueList" class="checkGrid"></div>
    <div class="buttonRow" style="margin-top:12px;">
      <button type="button" id="btnSelectAllLeagues">Select all</button>
      <button type="button" class="danger" id="btnClearAllLeagues">Clear</button>
    </div>
  </section>

  <section id="oddsPanel" class="inlinePanel" style="display:none;">
    <div class="inlinePanelHeader">
      <div class="inlinePanelTitle">Odds Buckets</div>
      <button type="button" class="smallBtn" id="btnHideOddsPanel">Close</button>
    </div>
    <div class="smallHint">Overview by odds range (auto-updates from your current filters).</div>
    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th>Bucket</th>
            <th>Bets</th>
            <th>Wins</th>
            <th>Losses</th>
            <th>Pending</th>
            <th>ROI</th>
          </tr>
        </thead>
        <tbody id="oddsBucketsTbody"></tbody>
      </table>
    </div>
  </section>


    <!-- CALCULATOR -->
    <section id="screenCalc" class="panel" style="margin-top:12px; display:none;">
      <div class="sectionTitle">Calculate Edge (Proportional â€” de-vig)</div>

      <div class="calcBox">
        <div class="row tight">
          <div class="field">
            <label>Market Type</label>
            <select id="marketType">
              <option value="2">2-Way (Home/Away)</option>
              <option value="3">3-Way (Home/Draw/Away)</option>
            </select>
          </div>
          <div class="field">
            <label>League (optional)</label>
            <input id="calcLeague" list="leagueList" placeholder="Select or type custom..." autocomplete="off" />
          </div>
          <div class="field">
            <label>Date</label>
            <input id="calcDate" type="date" />
          </div>
        </div>

        <div class="sep"></div>

        <div class="row tight">
          <div class="field">
            <label>Pinnacle Home</label>
            <input id="pHome" inputmode="decimal" enterkeyhint="next" placeholder="2.77" />
          </div>
          <div class="field" id="wrapPDraw" style="display:none;">
            <label>Pinnacle Draw</label>
            <input id="pDraw" inputmode="decimal" enterkeyhint="next" placeholder="3.25" />
          </div>
          <div class="field">
            <label>Pinnacle Away</label>
            <input id="pAway" inputmode="decimal" enterkeyhint="next" placeholder="1.46" />
          </div>
        </div>

        <div class="row tight" style="margin-top:10px;">
          <div class="field">
            <label>Your Home</label>
            <input id="yHome" inputmode="decimal" enterkeyhint="next" placeholder="3.50" />
          </div>
          <div class="field" id="wrapYDraw" style="display:none;">
            <label>Your Draw</label>
            <input id="yDraw" inputmode="decimal" enterkeyhint="next" placeholder="3.10" />
          </div>
          <div class="field">
            <label>Your Away</label>
            <input id="yAway" inputmode="decimal" enterkeyhint="next" placeholder="1.40" />
          </div>
        </div>

        <div class="row tight" style="margin-top:10px;">
          <button class="btn primary" id="btnCalc" type="button">âœ¨ Calculate Edge</button>
          <button class="btn" id="btnReloadCalc" type="button">â†» Reload</button>
        </div>

        <div id="calcOut" class="calcResult" style="display:none;"></div>
      </div>

      <div class="sectionTitle">Calculation History</div>
      <div class="row tight" style="align-items:center;">
        <button class="btn bad" id="btnClearHistory" type="button">ðŸ§¨ Clear History</button>
      </div>
      <div id="history"></div>
    </section>
  </div>

  <!-- FILTERS MODAL -->
  





<script>
(()=>{
  if (window.__BA_INITED) return;
  window.__BA_INITED = true;

    const STORAGE_KEY = "ba_proportional_v3_bets";
    const STORAGE_LEAGUES_KEY = "ba_proportional_v3_leagues_custom";
    const STORAGE_CALC_HISTORY = "ba_proportional_v3_calc_history";
    const STORAGE_FILTERS = "ba_proportional_v3_filters";

    const PREDEFINED_LEAGUES = [
      "Premier League","La Liga","Serie A","Bundesliga","Ligue 1","UCL","Europa League",
      "NBA","NFL","Euroleague","Tennis ATP","Tennis WTA",
      "Eredivisie","Primeira Liga","Scottish Premiership","Super Lig","Swiss Super League",
      "EFL Cup","FA Cup","Copa del Rey","Coppa Italia","Coupe de France","DFB Pokal","Greek Cup","KNVB Beker",
      "Conference League","World Cup","Euro Championship","Copa America","UEFA Nations League",
      "Championship","Segunda Division","Serie B","2. Bundesliga","Ligue 2","Super League 2",
      "MLS","Liga MX","Copa Libertadores","Copa Sudamericana","Copa do Brasil","US Open Cup","Leagues Cup",
      "Eurocup","Greek Basket League","Spain ACB","Italy Lega A","Germany BBL","France LNB",
      "Eurobasket","NBA Playoffs","NCAA Football","NFL Playoffs","Super Bowl","MLB","MLB Playoffs","World Series","NHL","NHL Playoffs","Stanley Cup",
      "Grand Slams","UFC","Boxing",
      "Volleyball","Handball","Rugby","Cricket","United Cup","Davis Cup","Billie Jean King Cup","ATP Finals","WTA Finals","ATP Masters 1000","ATP 500","ATP 250","WTA 1000","WTA 500","WTA 250","ATP Challenger",
      "ITF Tennis","Olympics (Tennis)","Africa Cup of Nations","CAF Champions League","CAF Confederation Cup","Asian Cup","AFC Champions League","AFC Cup",
      "CONCACAF Gold Cup","CONCACAF Champions Cup","WC Qualifiers","International Friendlies",
      "Other"
    ];

    const DEFAULT_ODDS_BUCKETS = [
      { label:"1.00â€“1.49", min:1.00, max:1.49 },
      { label:"1.50â€“1.99", min:1.50, max:1.99 },
      { label:"2.00â€“2.49", min:2.00, max:2.49 },
      { label:"2.50â€“2.99", min:2.50, max:2.99 },
      { label:"3.00â€“3.99", min:3.00, max:3.99 },
      { label:"4.00â€“4.99", min:4.00, max:4.99 },
      { label:"5.00â€“9.99", min:5.00, max:9.99 },
      { label:"10.00+", min:10.00, max:Infinity },
    ];

    const $ = (id)=>document.getElementById(id);

    function uid(){ return "b_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16); }
    function normalizeLeague(s){ if(!s) return ""; return s.trim().replace(/\s+/g," "); }
    function parseDec(x){
      if(x === null || x === undefined) return NaN;
      const s = String(x).trim().replace(",", ".");
      if(s === "") return NaN;
      const n = Number(s);
      return Number.isFinite(n) ? n : NaN;
    }
    function fmt2(n){ if(!Number.isFinite(n)) return "0.00"; return (Math.round(n*100)/100).toFixed(2); }
    function fmtPct(n){ if(!Number.isFinite(n)) return "0.00%"; const v = Math.round(n*100)/100; return v.toFixed(2) + "%"; }
    function isValidDateStr(d){ return /^\d{4}-\d{2}-\d{2}$/.test(d); }
    function todayISO(){
      const d = new Date(); const z = (v)=>String(v).padStart(2,"0");
      return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`;
    }
    function computePLUnits(b){
      const u = Number(b.units); const o = Number(b.odds);
      if(!Number.isFinite(u) || !Number.isFinite(o)) return 0;
      if(b.result === "WIN") return u*(o-1);
      if(b.result === "LOSS") return -u;
      return 0;
    }

    let bets = [];
    let customLeagues = [];
    let filters = {
      leaguesSelected: ["ALL"],
      dateFrom: "", dateTo: "",
      edgeFrom: "", edgeTo: "",
      oddsFrom: "", oddsTo: ""
    };

    function loadAll(){
      try{ bets = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); if(!Array.isArray(bets)) bets = []; }catch{ bets = []; }
      let changed = false;
      for(const b of bets){
        if(!b.id){ b.id = uid(); changed = true; }
        if(!b.createdAt){
          b.createdAt = b.date ? (new Date(b.date).getTime() || Date.now()) : Date.now();
          changed = true;
        }
        if(!b.league) b.league = "Other";
        b.league = normalizeLeague(b.league) || "Other";
        if(!["WIN","LOSS","PENDING"].includes(b.result)) { b.result = "PENDING"; changed = true; }
      }
      if(changed) saveBets();

      try{ customLeagues = JSON.parse(localStorage.getItem(STORAGE_LEAGUES_KEY) || "[]"); if(!Array.isArray(customLeagues)) customLeagues = []; }catch{ customLeagues = []; }
      try{
        const f = JSON.parse(localStorage.getItem(STORAGE_FILTERS) || "null");
        if(f && typeof f === "object"){ filters = { ...filters, ...f }; }
      }catch{}
    }
    function saveBets(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(bets)); }
    function saveCustomLeagues(){ localStorage.setItem(STORAGE_LEAGUES_KEY, JSON.stringify(customLeagues)); }
    function saveFilters(){ localStorage.setItem(STORAGE_FILTERS, JSON.stringify(filters)); }

    function getObservedLeagues(){
      const set = new Set();
      for(const b of bets){ const L = normalizeLeague(b.league); if(L) set.add(L); }
      return Array.from(set);
    }
    function isPredefinedLeague(L){ return PREDEFINED_LEAGUES.includes(L); }

    function rebuildLeagueUniverse(){
      const obs = getObservedLeagues();
      const set = new Set(customLeagues.map(normalizeLeague).filter(Boolean));
      for(const L of obs){
        if(L && !isPredefinedLeague(L) && L !== "Other"){ set.add(L); }
      }
      customLeagues = Array.from(set).sort((a,b)=>a.localeCompare(b));
      saveCustomLeagues();
    }
    function getAllSelectableLeagues(){
      const base = PREDEFINED_LEAGUES.filter(x=>x !== "Other");
      const all = [...base, ...customLeagues];
      const set = new Set(all.map(normalizeLeague).filter(Boolean));
      return Array.from(set).sort((a,b)=>a.localeCompare(b));
    }
    function refreshDatalist(){
      const dl = $("leagueList"); dl.innerHTML = "";
      const all = getAllSelectableLeagues();
      for(const L of all){ const opt = document.createElement("option"); opt.value = L; dl.appendChild(opt); }
    }

    function betPassesFilters(b){
      const bt = $("betType").value;
      if(bt === "live" && !b.live) return false;
      if(bt === "prematch" && b.live) return false;

      const sel = filters.leaguesSelected || ["ALL"];
      const L = normalizeLeague(b.league) || "Other";
      const inAll = sel.includes("ALL");

      if(!inAll){
        const wantOther = sel.includes("OTHER");
        const wantSpecific = sel.filter(x=>x!=="OTHER" && x!=="ALL");
        const isOther = !isPredefinedLeague(L);
        let ok = false;
        if(wantSpecific.length && wantSpecific.includes(L)) ok = true;
        if(wantOther && isOther) ok = true;
        if(!ok) return false;
      }

      if(filters.dateFrom && isValidDateStr(filters.dateFrom)){
        if(!b.date || b.date < filters.dateFrom) return false;
      }
      if(filters.dateTo && isValidDateStr(filters.dateTo)){
        if(!b.date || b.date > filters.dateTo) return false;
      }

      const e = Number(b.edge);
      const ef = parseDec(filters.edgeFrom);
      const et = parseDec(filters.edgeTo);
      if(Number.isFinite(ef) && !(e >= ef)) return false;
      if(Number.isFinite(et) && !(e <= et)) return false;

      const o = Number(b.odds);
      const of = parseDec(filters.oddsFrom);
      const ot = parseDec(filters.oddsTo);
      if(Number.isFinite(of) && !(o >= of)) return false;
      if(Number.isFinite(ot) && !(o <= ot)) return false;

      return true;
    }
    function getFilteredBets(){ return bets.filter(betPassesFilters); }

    function computeStats(arr){
      const total = arr.length;
      let wins=0, losses=0, pending=0;
      let wagered=0; let pl=0;
      let edgeWeightedSum=0; let edgeUnitsSum=0;
      for(const b of arr){
        const u = Number(b.units);
        const edge = Number(b.edge);
        const p = computePLUnits(b);

        if(b.result === "WIN") wins++;
        else if(b.result === "LOSS") losses++;
        else pending++;

        if(Number.isFinite(u)){
          wagered += u;
          if(Number.isFinite(edge)){
            edgeWeightedSum += edge * u;
            edgeUnitsSum += u;
          }
        }
        pl += p;
      }
      const winPct = (wins + losses) ? (wins/(wins+losses))*100 : 0;
      const roi = wagered ? (pl/wagered)*100 : 0;
      const avgEdge = edgeUnitsSum ? (edgeWeightedSum/edgeUnitsSum) : 0;
      return { total,wins,losses,pending,winPct,wagered,pl,roi,avgEdge };
    }

    function renderStats(){
      const arr = getFilteredBets();
      const s = computeStats(arr);
      const grid = $("statsGrid");
      grid.innerHTML = "";
      const cards = [
        ["TOTAL BETS", s.total, "cyan"],
        ["WINS", s.wins, ""],
        ["LOSSES", s.losses, ""],
        ["PENDING", s.pending, ""],
        ["WIN %", fmtPct(s.winPct), ""],
        ["TOTAL UNITS", fmt2(s.pl), s.pl>=0 ? "good":"bad"],
        ["TOTAL WAGERED", fmt2(s.wagered), ""],
        ["ROI %", fmtPct(s.roi), s.roi>=0 ? "good":"bad"],
        ["AVG EDGE %", fmtPct(s.avgEdge), ""]
      ];
      for(const [k,v,cls] of cards){
        const d = document.createElement("div");
        d.className = "card";
        d.innerHTML = `<div class="k">${k}</div><div class="v ${cls||""}">${v}</div>`;
        grid.appendChild(d);
      }
    }

    function escapeHtml(s){
      return String(s||"").replace(/[&<>"']/g, m=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    function renderBetsTable(){
      const tbody = $("betsTbody");
      tbody.innerHTML = "";
      const arr = getFilteredBets().slice().sort((a,b)=> (a.createdAt||0) - (b.createdAt||0));
      for(const b of arr){
        const tr = document.createElement("tr");
        const pl = computePLUnits(b);
        const resultPill = b.result === "WIN" ? "win" : b.result === "LOSS" ? "loss" : "pending";
        const plCls = pl >= 0 ? "good" : "bad";
        tr.innerHTML = `
          <td class="mono">${b.date || ""}</td>
          <td>${escapeHtml(b.league)}</td>
          <td class="mono">${fmt2(Number(b.odds))}</td>
          <td class="mono">${fmt2(Number(b.units))}</td>
          <td class="mono">${fmtPct(Number(b.edge))}</td>
          <td class="mono pl ${plCls}">${pl>=0?"+":""}${fmt2(pl)}</td>
          <td><span class="pill ${resultPill}">${b.result}</span></td>
          <td>${b.live ? "âœ…" : "â€”"}</td>
          <td><button class="iconBtn bad" title="Delete" data-del="${b.id}" type="button">ðŸ—‘</button></td>
        `;
        tbody.appendChild(tr);
      }
      tbody.querySelectorAll("[data-del]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-del");
          deleteBetById(id);
        });
      });
    }

    function deleteBetById(id){
      const idx = bets.findIndex(x=>x.id === id);
      if(idx === -1){ alert("Could not find bet to delete (already removed?)"); return; }
      const b = bets[idx];
      const ok = confirm(`Delete bet?\n\n${b.date || ""} â€” ${b.league}\nOdds: ${fmt2(b.odds)} | Units: ${fmt2(b.units)} | Result: ${b.result}`);
      if(!ok) return;
      bets.splice(idx,1);
      saveBets();
      rebuildLeagueUniverse();
      refreshDatalist();
      renderAll();
    }

    function addBetFromTracker(){
      const date = $("inDate").value || "";
      const leagueRaw = $("inLeague").value;
      const league = normalizeLeague(leagueRaw) || "Other";
      const odds = parseDec($("inOdds").value);
      const units = parseDec($("inUnits").value);
      const edge = parseDec($("inEdge").value);
      const result = $("inResult").value;
      const live = $("inLive").value === "1";

      if(!isValidDateStr(date)){ alert("Please fill Date."); return; }
      if(!Number.isFinite(odds) || odds <= 1){ alert("Please fill valid Odds (> 1.00)."); return; }
      if(!Number.isFinite(units) || units <= 0){ alert("Please fill valid Units (> 0)."); return; }
      if(!Number.isFinite(edge)){ alert("Please fill valid Edge % (number)."); return; }

      if(league && !isPredefinedLeague(league) && league !== "Other"){
        if(!customLeagues.includes(league)){
          customLeagues.push(league);
          customLeagues.sort((a,b)=>a.localeCompare(b));
          saveCustomLeagues();
          refreshDatalist();
        }
      }

      const b = { id: uid(), createdAt: Date.now(), date, league, odds:Number(odds), units:Number(units), edge:Number(edge), result, live };
      bets.push(b);
      saveBets();
      rebuildLeagueUniverse();
      refreshDatalist();
      clearTrackerInputs();
      renderAll();
    }
    function clearTrackerInputs(){
      $("inOdds").value = "";
      $("inUnits").value = "";
      $("inEdge").value = "";
      $("inResult").value = "PENDING";
      $("inLive").value = "0";
    }

    function openFilters(){
      buildLeagueChecks();
      $("fDateFrom").value = filters.dateFrom || "";
      $("fDateTo").value = filters.dateTo || "";
      $("fEdgeFrom").value = filters.edgeFrom || "";
      $("fEdgeTo").value = filters.edgeTo || "";
      $("fOddsFrom").value = filters.oddsFrom || "";
      $("fOddsTo").value = filters.oddsTo || "";
      $("modalFiltersBackdrop").style.display = "flex";
    }
    function closeFilters(){ $("modalFiltersBackdrop").style.display = "none"; }

    function buildLeagueChecks(){
      const box = $("leagueChecks");
      box.innerHTML = "";

      const make = (label, token)=>{
        const div = document.createElement("label");
        div.className = "chk";
        div.innerHTML = `<input type="checkbox" data-l="${token}"><span>${escapeHtml(label)}</span>`;
        const input = div.querySelector("input");
        input.checked = (filters.leaguesSelected||[]).includes(token);
        input.addEventListener("change", ()=>{ onLeagueToggle(token, input.checked); });
        box.appendChild(div);
      };

      make("ALL LEAGUES", "ALL");

      const leagues = getAllSelectableLeagues();
      for(const L of leagues){ make(L, L); }

      make("OTHER", "OTHER");
    }

    function onLeagueToggle(token, checked){
      let sel = new Set(filters.leaguesSelected || ["ALL"]);
      if(token === "ALL"){
        sel = new Set(["ALL"]);
      }else{
        sel.delete("ALL");
        if(checked) sel.add(token);
        else sel.delete(token);
        if(sel.size === 0) sel.add("ALL");
      }
      filters.leaguesSelected = Array.from(sel);
      buildLeagueChecks();
    }

    function applyFilters(){
      filters.dateFrom = $("fDateFrom").value || "";
      filters.dateTo = $("fDateTo").value || "";
      filters.edgeFrom = $("fEdgeFrom").value || "";
      filters.edgeTo = $("fEdgeTo").value || "";
      filters.oddsFrom = $("fOddsFrom").value || "";
      filters.oddsTo = $("fOddsTo").value || "";
      saveFilters();
      closeFilters();
      renderAll();
    }

    function resetFilters(){
      filters = { leaguesSelected:["ALL"], dateFrom:"", dateTo:"", edgeFrom:"", edgeTo:"", oddsFrom:"", oddsTo:"" };
      saveFilters();
      buildLeagueChecks();
      $("fDateFrom").value = "";
      $("fDateTo").value = "";
      $("fEdgeFrom").value = "";
      $("fEdgeTo").value = "";
      $("fOddsFrom").value = "";
      $("fOddsTo").value = "";
      renderAll();
    }

    function openOddsBuckets(){ buildOddsBucketsTable(); $("modalOddsBackdrop").style.display = "flex"; }
    function closeOddsBuckets(){ $("modalOddsBackdrop").style.display = "none"; }

    function buildOddsBucketsTable(){
      const tbody = $("oddsBucketsTbody");
      tbody.innerHTML = "";
      const arr = getFilteredBets();
      for(const bucket of DEFAULT_ODDS_BUCKETS){
        const inB = arr.filter(b=>{
          const o = Number(b.odds);
          return Number.isFinite(o) && o >= bucket.min && o <= bucket.max;
        });
        const s = computeStats(inB);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${bucket.label}</td>
          <td class="mono">${s.total}</td>
          <td class="mono">${s.wins}</td>
          <td class="mono">${s.losses}</td>
          <td class="mono">${s.pending}</td>
          <td class="mono">${fmt2(s.wagered)}</td>
          <td class="mono ${s.pl>=0?"pl good":"pl bad"}">${s.pl>=0?"+":""}${fmt2(s.pl)}</td>
          <td class="mono ${s.roi>=0?"pl good":"pl bad"}">${fmtPct(s.roi)}</td>
          <td class="mono">${fmtPct(s.avgEdge)}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    function dangerReset(){
      const ok = confirm("Reset options:\n\nOK = Reset FILTERS ONLY (safe)\nCancel = do nothing.\n\nIf you want to WIPE ALL DATA, use Export first, then type WIPE in the next prompt.");
      if(!ok) return;
      resetFilters();
      const wipe = prompt("If you REALLY want to delete ALL bets & history, type WIPE and press OK.\n(Leave blank to keep data.)");
      if(wipe === "WIPE"){
        localStorage.removeItem(STORAGE_KEY);
        localStorage.removeItem(STORAGE_LEAGUES_KEY);
        localStorage.removeItem(STORAGE_CALC_HISTORY);
        localStorage.removeItem(STORAGE_FILTERS);
        bets = [];
        customLeagues = [];
        filters.leaguesSelected = ["ALL"];
        refreshDatalist();
        renderAll();
        renderCalcHistory();
        alert("All data wiped.");
      }else{
        alert("Filters reset. Data kept.");
      }
    }

    function downloadText(filename, text){
      const blob = new Blob([text], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function exportCSV(){
      const cols = ["id","createdAt","date","league","odds","units","edge","result","live"];
      const lines = [cols.join(",")];
      for(const b of bets.slice().sort((a,b)=> (a.createdAt||0)-(b.createdAt||0))){
        const row = cols.map(c=>{
          let v = b[c];
          if(v === undefined || v === null) v = "";
          if(c === "live") v = b.live ? "1" : "0";
          const s = String(v);
          if(/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
          return s;
        });
        lines.push(row.join(","));
      }
      downloadText("proportional_bets.csv", lines.join("\n"));
    }

    function parseCSV(text){
      const rows = [];
      let row = [];
      let cur = "";
      let inQ = false;
      for(let i=0;i<text.length;i++){
        const ch = text[i];
        const next = text[i+1];
        if(inQ){
          if(ch === '"' && next === '"'){ cur += '"'; i++; }
          else if(ch === '"'){ inQ = false; }
          else cur += ch;
        }else{
          if(ch === '"'){ inQ = true; }
          else if(ch === ","){ row.push(cur); cur=""; }
          else if(ch === "\n"){
            row.push(cur); cur="";
            if(row.length>1 || row[0].trim()!=="") rows.push(row);
            row = [];
          }else if(ch === "\r"){ }
          else cur += ch;
        }
      }
      if(cur.length || row.length){
        row.push(cur);
        if(row.length>1 || row[0].trim()!=="") rows.push(row);
      }
      return rows;
    }

    function importCSVFile(file){
      const reader = new FileReader();
      reader.onload = ()=>{
        const text = String(reader.result || "");
        const imported = parseCSV(text);
        if(!imported.length){ alert("No rows found in CSV."); return; }

        const headers = imported[0].map(h=>String(h).trim());
        const rows = imported.slice(1);
        const idx = (name)=> headers.findIndex(h=>h.toLowerCase()===name.toLowerCase());

        const map = {
          id: idx("id"), createdAt: idx("createdAt"),
          date: idx("date"), league: idx("league"),
          odds: idx("odds"), units: idx("units"), edge: idx("edge"),
          result: idx("result"), live: idx("live")
        };

        let added=0, updated=0;
        const byId = new Map(bets.map(b=>[b.id,b]));

        for(const r of rows){
          const b = {};
          b.id = map.id>=0 ? String(r[map.id]||"").trim() : "";
          if(!b.id) b.id = uid();

          b.createdAt = map.createdAt>=0 ? Number(r[map.createdAt]) : NaN;
          if(!Number.isFinite(b.createdAt)) b.createdAt = Date.now();

          b.date = map.date>=0 ? String(r[map.date]||"").trim() : "";
          b.league = normalizeLeague(map.league>=0 ? String(r[map.league]||"") : "Other") || "Other";

          b.odds = parseDec(map.odds>=0 ? r[map.odds] : "");
          b.units = parseDec(map.units>=0 ? r[map.units] : "");
          b.edge = parseDec(map.edge>=0 ? r[map.edge] : "");

          b.result = map.result>=0 ? String(r[map.result]||"PENDING").trim().toUpperCase() : "PENDING";
          if(!["WIN","LOSS","PENDING"].includes(b.result)) b.result="PENDING";

          const lv = map.live>=0 ? String(r[map.live]||"0").trim() : "0";
          b.live = (lv === "1" || lv.toLowerCase()==="true" || lv.toLowerCase()==="yes");

          if(!isValidDateStr(b.date)) continue;
          if(!Number.isFinite(b.odds) || b.odds <= 1) continue;
          if(!Number.isFinite(b.units) || b.units <= 0) continue;
          if(!Number.isFinite(b.edge)) b.edge = 0;

          if(byId.has(b.id)){
            Object.assign(byId.get(b.id), b);
            updated++;
          }else{
            bets.push(b);
            byId.set(b.id,b);
            added++;
          }
        }

        const seen = new Set();
        const cleaned = [];
        for(const b of bets.slice().sort((a,b)=> (a.createdAt||0)-(b.createdAt||0))){
          const key = [
            b.date, normalizeLeague(b.league),
            fmt2(Number(b.odds)), fmt2(Number(b.units)), fmt2(Number(b.edge)),
            b.result, b.live ? "1":"0"
          ].join("|");
          if(seen.has(key)) continue;
          seen.add(key);
          cleaned.push(b);
        }
        bets = cleaned;

        saveBets();
        rebuildLeagueUniverse();
        refreshDatalist();
        renderAll();
        alert(`Import done.\nAdded: ${added}\nUpdated: ${updated}\nTotal bets now: ${bets.length}`);
      };
      reader.readAsText(file);
    }

    function setMarketUI(){
      const m = $("marketType").value;
      $("wrapPDraw").style.display = (m==="3") ? "block" : "none";
      $("wrapYDraw").style.display = (m==="3") ? "block" : "none";
    }

    function proportionalFairOdds(pOddsArr){
      const probs = pOddsArr.map(o => 1/ o);
      const sum = probs.reduce((a,b)=>a+b,0);
      const fairProbs = probs.map(p => p/sum);
      const fairOdds = fairProbs.map(p => 1/p);
      return { fairProbs, fairOdds };
    }
    function evPercent(userOdds, fairProb){ return (userOdds * fairProb - 1) * 100; }

    function renderCalcResult(result){
      const out = $("calcOut");
      out.style.display = "block";
      const m = $("marketType").value;
      const ts = new Date().toLocaleString();
      let html = `<h4>${m==="2" ? "2-WAY" : "3-WAY"} <span style="float:right; color:rgba(137,168,199,.95); font-weight:700;">${ts}</span></h4>`;
      const blocks = [];
      for(const item of result.items){
        blocks.push(`
          <div class="calcResult" style="margin-top:10px;">
            <h4>${item.name.toUpperCase()}</h4>
            <div class="kv">
              <div class="k">Pinn:</div><div class="v mono">${fmt2(item.pinn)}</div>
              <div class="k">Your:</div><div class="v mono">${fmt2(item.your)}</div>
              <div class="k">Fair (Prop):</div><div class="v mono">${fmt2(item.fair)}</div>
              <div class="k">EV% (Prop):</div><div class="v mono" style="color:${item.ev>=0?'var(--green)':'var(--red)'};">${item.ev>=0?"+":""}${fmtPct(item.ev)}</div>
            </div>
            <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn good" data-addcalc="${item.key}" type="button">ADD BET</button>
            </div>
          </div>
        `);
      }
      out.innerHTML = html + blocks.join("");

      out.querySelectorAll("[data-addcalc]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const key = btn.getAttribute("data-addcalc");
          openAddFromCalc(result, key);
        });
      });

      pushCalcHistory(result);
      renderCalcHistory();
    }

    function calcNow(){
      const m = $("marketType").value;
      const pH = parseDec($("pHome").value);
      const pA = parseDec($("pAway").value);
      const yH = parseDec($("yHome").value);
      const yA = parseDec($("yAway").value);

      if(!Number.isFinite(pH) || !Number.isFinite(pA) || pH<=1 || pA<=1){
        alert("Fill valid Pinnacle Home/Away odds (>1.00)."); return;
      }
      if(!Number.isFinite(yH) || !Number.isFinite(yA) || yH<=1 || yA<=1){
        alert("Fill valid Your Home/Away odds (>1.00)."); return;
      }

      let pOdds = [pH], yOdds = [yH], keys = ["HOME"], names = ["Home"];
      if(m==="3"){
        const pD = parseDec($("pDraw").value);
        const yD = parseDec($("yDraw").value);
        if(!Number.isFinite(pD) || pD<=1){ alert("Fill valid Pinnacle Draw odds (>1.00)."); return; }
        if(!Number.isFinite(yD) || yD<=1){ alert("Fill valid Your Draw odds (>1.00)."); return; }
        pOdds = [pH, pD, pA]; yOdds = [yH, yD, yA];
        keys = ["HOME","DRAW","AWAY"]; names = ["Home","Draw","Away"];
      }else{
        pOdds = [pH, pA]; yOdds = [yH, yA];
        keys = ["HOME","AWAY"]; names = ["Home","Away"];
      }

      const { fairProbs, fairOdds } = proportionalFairOdds(pOdds);

      const items = keys.map((k,i)=>({
        key: k, name: names[i],
        pinn: pOdds[i], your: yOdds[i],
        fair: fairOdds[i],
        ev: evPercent(yOdds[i], fairProbs[i])
      }));

      const result = {
        id: "c_" + uid(),
        ts: Date.now(),
        market: m==="3" ? "3-WAY" : "2-WAY",
        league: normalizeLeague($("calcLeague").value) || "",
        date: $("calcDate").value || "",
        items
      };

      renderCalcResult(result);
    }

    function loadCalcHistory(){
      try{ const h = JSON.parse(localStorage.getItem(STORAGE_CALC_HISTORY) || "[]"); return Array.isArray(h) ? h : []; }catch{ return []; }
    }
    function saveCalcHistory(h){ localStorage.setItem(STORAGE_CALC_HISTORY, JSON.stringify(h)); }
    function pushCalcHistory(result){
      const h = loadCalcHistory();
      h.unshift(result);
      while(h.length>50) h.pop();
      saveCalcHistory(h);
    }

    function renderCalcHistory(){
      const host = $("history");
      host.innerHTML = "";
      const h = loadCalcHistory();
      if(!h.length){ host.innerHTML = `<div class="note" style="margin-top:10px;">No history yet.</div>`; return; }
      for(const r of h){
        const div = document.createElement("div");
        div.className = "historyItem";
        const dt = new Date(r.ts||Date.now()).toLocaleString();
        const league = r.league ? ` â€¢ ${escapeHtml(r.league)}` : "";
        const date = r.date ? ` â€¢ ${escapeHtml(r.date)}` : "";
        div.innerHTML = `
          <div class="historyTop">
            <div><b>${escapeHtml(r.market||"")}</b>${league}${date}</div>
            <div>${dt}</div>
          </div>
          ${r.items.map(it=>`
            <div class="calcResult" style="margin-top:8px;">
              <h4>${it.name.toUpperCase()}</h4>
              <div class="kv">
                <div class="k">Pinn:</div><div class="v mono">${fmt2(it.pinn)}</div>
                <div class="k">Your:</div><div class="v mono">${fmt2(it.your)}</div>
                <div class="k">Fair (Prop):</div><div class="v mono">${fmt2(it.fair)}</div>
                <div class="k">EV% (Prop):</div><div class="v mono" style="color:${it.ev>=0?'var(--green)':'var(--red)'};">${it.ev>=0?"+":""}${fmtPct(it.ev)}</div>
              </div>
              <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
                <button class="btn good" style="padding:8px 10px; font-size:11px;" data-addhist="${r.id}|${it.key}" type="button">ADD BET</button>
              </div>
            </div>
          `).join("")}
          <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn" data-reload="${r.id}" type="button">RELOAD</button>
            <button class="btn bad" data-remove="${r.id}" type="button">REMOVE</button>
          </div>
        `;
        host.appendChild(div);
      }

      host.querySelectorAll("[data-reload]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-reload");
          const h = loadCalcHistory();
          const r = h.find(x=>x.id===id);
          if(!r) return;
          $("marketType").value = (r.market==="3-WAY") ? "3" : "2";
          setMarketUI();
          $("calcLeague").value = r.league || "";
          $("calcDate").value = r.date || "";
          if(r.market==="2-WAY"){
            const home = r.items.find(x=>x.key==="HOME") || r.items[0];
            const away = r.items.find(x=>x.key==="AWAY") || r.items[1];
            $("pHome").value = fmt2(home.pinn);
            $("pAway").value = fmt2(away.pinn);
            $("yHome").value = fmt2(home.your);
            $("yAway").value = fmt2(away.your);
          }else{
            const home = r.items.find(x=>x.key==="HOME") || r.items[0];
            const draw = r.items.find(x=>x.key==="DRAW") || r.items[1];
            const away = r.items.find(x=>x.key==="AWAY") || r.items[2];
            $("pHome").value = fmt2(home.pinn);
            $("pDraw").value = fmt2(draw.pinn);
            $("pAway").value = fmt2(away.pinn);
            $("yHome").value = fmt2(home.your);
            $("yDraw").value = fmt2(draw.your);
            $("yAway").value = fmt2(away.your);
          }
          window.scrollTo({top:0, behavior:"smooth"});
        });
      });

      host.querySelectorAll("[data-remove]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-remove");
          const ok = confirm("Remove this history entry?");
          if(!ok) return;
          const h = loadCalcHistory().filter(x=>x.id!==id);
          saveCalcHistory(h);
          renderCalcHistory();
        });
      });

      host.querySelectorAll("[data-addhist]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const v = btn.getAttribute("data-addhist") || "";
          const [id,key] = v.split("|");
          const h = loadCalcHistory().find(x=>x.id===id);
          if(!h) return;
          // open add-bet flow using stored calc result
          openAddFromCalc(h, key);
        });
      });
    }

    function clearCalcInputs(){
      $("pHome").value = ""; $("pAway").value = "";
      $("yHome").value = ""; $("yAway").value = "";
      $("pDraw").value = ""; $("yDraw").value = "";
      $("calcOut").style.display = "none";
      $("calcOut").innerHTML = "";
    }

    let lastCalcResult = null;
    function openAddFromCalc(result, key){
      lastCalcResult = result;
      const item = result.items.find(x=>x.key===key) || result.items[0];
      $("afcDate").value = result.date || todayISO();
      $("afcLeague").value = normalizeLeague(result.league) || "Other";
      $("afcOutcome").value = item.name;
      $("afcOdds").value = fmt2(item.your);
      $("afcEdge").value = (Math.round(item.ev*100)/100).toFixed(2);
      $("afcUnits").value = "1";
      $("afcResult").value = "PENDING";
      $("afcLive").value = "0";
      $("modalAddFromCalcBackdrop").style.display = "flex";
    }
    function closeAddFromCalc(){ $("modalAddFromCalcBackdrop").style.display = "none"; }

    function addBetFromCalcConfirm(){
      if(!lastCalcResult){ alert("No calculation selected."); return; }
      const date = $("afcDate").value || "";
      const league = normalizeLeague($("afcLeague").value) || "Other";
      const odds = parseDec($("afcOdds").value);
      const edge = parseDec($("afcEdge").value);
      const units = parseDec($("afcUnits").value);
      const result = $("afcResult").value;
      const live = $("afcLive").value === "1";

      if(!isValidDateStr(date)){ alert("Please fill Date."); return; }
      if(!Number.isFinite(odds) || odds<=1){ alert("Invalid odds."); return; }
      if(!Number.isFinite(edge)){ alert("Invalid edge."); return; }
      if(!Number.isFinite(units) || units<=0){ alert("Invalid units (>0)."); return; }

      if(league && !isPredefinedLeague(league) && league !== "Other"){
        if(!customLeagues.includes(league)){
          customLeagues.push(league);
          customLeagues.sort((a,b)=>a.localeCompare(b));
          saveCustomLeagues();
          refreshDatalist();
        }
      }

      const b = { id: uid(), createdAt: Date.now(), date, league, odds:Number(odds), units:Number(units), edge:Number(edge), result, live };
      bets.push(b);
      saveBets();
      rebuildLeagueUniverse();
      refreshDatalist();
      closeAddFromCalc();
      switchTab("tracker");
      renderAll();
    }

    function switchTab(which){
      if(which==="tracker"){
        $("tabTracker").classList.add("active");
        $("tabCalc").classList.remove("active");
        $("screenTracker").style.display = "block";
        $("screenCalc").style.display = "none";
      }else{
        $("tabCalc").classList.add("active");
        $("tabTracker").classList.remove("active");
        $("screenCalc").style.display = "block";
        $("screenTracker").style.display = "none";
      }
    }

    function renderAll(){
      renderStats();
      renderBetsTable();
      if($("modalOddsBackdrop").style.display === "flex"){ buildOddsBucketsTable(); }
    }

    function init(){
      loadAll();
      rebuildLeagueUniverse();
      refreshDatalist();

      $("inDate").value = todayISO();
      $("calcDate").value = todayISO();
      $("betType").value = "all";
      setMarketUI();

      $("tabTracker").addEventListener("click", ()=>switchTab("tracker"));
      $("tabCalc").addEventListener("click", ()=>{ switchTab("calc"); renderCalcHistory(); });

      $("btnAddBet").addEventListener("click", addBetFromTracker);

      const order = ["inOdds","inUnits","inEdge"];
      order.forEach((id, idx)=>{
        $(id).addEventListener("keydown", (e)=>{
          if(e.key==="Enter"){
            e.preventDefault();
            if(idx < order.length-1) $(order[idx+1]).focus();
            else $("btnAddBet").click();
          }
        });
      });

      $("btnFilters").addEventListener("click", openFilters);
      $("btnCloseFilters").addEventListener("click", closeFilters);
      $("btnApplyFilters").addEventListener("click", applyFilters);
      $("btnResetFilters").addEventListener("click", resetFilters);

      $("btnOddsStats").addEventListener("click", openOddsBuckets);
      $("btnCloseOdds").addEventListener("click", closeOddsBuckets);

      $("betType").addEventListener("change", renderAll);

      $("btnDangerZone").addEventListener("click", dangerReset);

      $("btnExport").addEventListener("click", exportCSV);
      $("btnImport").addEventListener("click", ()=>$("fileImport").click());
      $("fileImport").addEventListener("change", ()=>{
        const f = $("fileImport").files && $("fileImport").files[0];
        if(!f) return;
        importCSVFile(f);
        $("fileImport").value = "";
      });

      $("marketType").addEventListener("change", setMarketUI);
      $("btnCalc").addEventListener("click", calcNow);
      $("btnReloadCalc").addEventListener("click", clearCalcInputs);

      $("btnClearHistory").addEventListener("click", ()=>{
        const ok = confirm("Clear calculation history?");
        if(!ok) return;
        localStorage.removeItem(STORAGE_CALC_HISTORY);
        renderCalcHistory();
      });

      $("btnCloseAddFromCalc").addEventListener("click", closeAddFromCalc);
      $("afcCancel").addEventListener("click", closeAddFromCalc);
      $("afcAdd").addEventListener("click", addBetFromCalcConfirm);

      ["modalFiltersBackdrop","modalOddsBackdrop","modalAddFromCalcBackdrop"].forEach(id=>{
        const el = $(id);
        if(!el) return;
        el.addEventListener("click", (e)=>{
          if(e.target === el){ el.style.display = "none"; }
        });
      });

      // Inline panel buttons
      const hideFilters = document.getElementById("btnHideFiltersPanel");
      if(hideFilters){ hideFilters.addEventListener("click", ()=>{ const fp=document.getElementById("filtersPanel"); if(fp) fp.style.display="none"; }); }
      const hideOdds = document.getElementById("btnHideOddsPanel");
      if(hideOdds){ hideOdds.addEventListener("click", ()=>{ const op=document.getElementById("oddsPanel"); if(op) op.style.display="none"; }); }

      const btnAll = document.getElementById("btnSelectAllLeagues");
      if(btnAll){
        btnAll.addEventListener("click", ()=>{
          document.querySelectorAll('#leagueList input[type="checkbox"]').forEach(cb=>{ cb.checked=true; });
          if(typeof applyFilters === "function"){ applyFilters(); }
        });
      }
      const btnNone = document.getElementById("btnClearAllLeagues");
      if(btnNone){
        btnNone.addEventListener("click", ()=>{
          document.querySelectorAll('#leagueList input[type="checkbox"]').forEach(cb=>{ cb.checked=false; });
          if(typeof applyFilters === "function"){ applyFilters(); }
        });
      }

      renderAll();
      renderCalcHistory();
    }

    init();
  
})();
</script>
</body>
</html>
